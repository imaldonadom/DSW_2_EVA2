<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Usuarios (Admin)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-3">
<div th:replace="fragments/navbar :: main"></div>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Usuarios</h2>
    <div>
      <a class="btn btn-outline-secondary me-2" th:href="@{/admin}">Volver</a>
      <a class="btn btn-warning" th:href="@{/logout}">Salir</a>
    </div>
  </div>

  <!-- Importar -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Importar usuarios (CSV)</span>
      <a class="btn btn-outline-secondary btn-sm" th:href="@{/api/usuarios/template}">Descargar plantilla CSV</a>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-start">
        <div class="col-lg-8">
          <label class="form-label">Pegar texto CSV</label>
          <textarea id="txtUsers" rows="6" class="form-control"
                    placeholder="username;password;role;enabled&#10;ana;1234;CLIENTE;true"></textarea>
          <div class="mt-2 d-flex align-items-center gap-2">
            <button id="btnUText" class="btn btn-primary">Importar texto</button>
            <small id="msgUText" class="text-muted">No hay texto</small>
          </div>
        </div>
        <div class="col-lg-4">
          <label class="form-label">Archivo CSV</label>
          <div class="input-group">
            <input id="fileUsers" type="file" class="form-control" accept=".csv,text/csv,text/plain">
            <button id="btnUFile" class="btn btn-outline-primary">Subir CSV</button>
          </div>
          <div class="form-text">Formato: <code>username;password;role;enabled</code></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla usuarios sencilla (lista actual) -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="tblUsers">
          <thead class="table-light">
          <tr><th>ID</th><th>Usuario</th><th>Rol</th><th>Habilitado</th><th class="text-end">Acciones</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const UAPI = {
  list: '/api/usuarios/list',          // <-- antes tenías /api/admin/usuarios
  importText: '/api/usuarios/import-text',
  importFile: '/api/usuarios/import-file'
};

const r = await fetch(UAPI.importText, {
  method:'POST',
  headers:{'Content-Type':'text/plain; charset=UTF-8'},
  body:t
});

const msgU = (t, ok=true)=>{
  const el = document.getElementById('msgUText');
  el.textContent = t;
  el.className = 'text-' + (ok ? 'success' : 'danger');
};

document.getElementById('btnUText').onclick = async ()=>{
  const t = document.getElementById('txtUsers').value.trim();
  if(!t){ msgU('No hay texto', false); return; }
  msgU('Procesando...');
  const r = await fetch(UAPI.importText, { method:'POST', headers:{'Content-Type':'text/plain; charset=UTF-8'}, body:t });
  if(r.ok){
    const j = await r.json();
    msgU(`OK: ${j.ok} | Fallas: ${j.fail}`);
    loadUsers();
  }else{
    msgU('Error al importar', false);
  }
};

document.getElementById('btnUFile').onclick = async ()=>{
  const f = document.getElementById('fileUsers').files[0];
  if(!f){ msgU('Selecciona un archivo', false); return; }
  msgU('Subiendo...');
  const fd = new FormData(); fd.append('file', f);
  const r = await fetch(UAPI.importFile, { method:'POST', body:fd });
  if(r.ok){
    const j = await r.json();
    msgU(`OK: ${j.ok} | Fallas: ${j.fail}`);
    document.getElementById('fileUsers').value = '';
    loadUsers();
  }else{
    msgU('Error al importar archivo', false);
  }
};

// Carga de tabla (ajústalo a tu endpoint real)
async function loadUsers(){
  const tb = document.querySelector('#tblUsers tbody');
  tb.innerHTML = '';
  try{
    const r = await fetch(UAPI.list);
    if(!r.ok) return;
    const L = await r.json();
    L.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.id ?? ''}</td>
        <td>${u.username ?? ''}</td>
        <td>${u.role ?? ''}</td>
        <td>${u.enabled ? 'Sí' : 'No'}</td>
        <td class="text-end"><span class="text-muted small">–</span></td>`;
      tb.appendChild(tr);
    });
  }catch(e){}
}
loadUsers();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
