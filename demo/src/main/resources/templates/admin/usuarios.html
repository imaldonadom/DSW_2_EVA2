<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Usuarios (Admin)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- Navbar común -->
<div th:replace="fragments/navbar :: main"></div>

<div class="container my-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Usuarios</h2>
  </div>

  <!-- Crear usuario -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header fw-semibold">Crear usuario</div>
    <div class="card-body">
      <form id="fNewUser" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Usuario</label>
          <input name="username" class="form-control" autocomplete="off" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Clave</label>
          <input name="password" type="password" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Rol</label>
          <select name="role" class="form-select">
            <option value="CLIENTE">CLIENTE</option>
            <option value="COMENSAL">COMENSAL</option>
            <option value="ADMIN">ADMIN</option>
          </select>
        </div>
        <div class="col-md-1">
          <label class="form-label">Activo</label>
          <select name="enabled" class="form-select">
            <option value="true" selected>Sí</option>
            <option value="false">No</option>
          </select>
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary">Crear</button>
          <span id="msgNew" class="text-muted"></span>
        </div>
      </form>
    </div>
  </div>

  <!-- Importar CSV -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Importar usuarios (CSV)</span>
      <a class="btn btn-sm btn-outline-secondary" th:href="@{/api/usuarios/plantilla}" download>Descargar plantilla CSV</a>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-start">
        <div class="col-lg-7">
          <label class="form-label">Pegar texto CSV</label>
          <textarea id="txtCSV" class="form-control" rows="5"
            placeholder="username;password;role;enabled&#10;ana;1234;CLIENTE;true"></textarea>

        </div>
        <div class="col-lg-5">
          <label class="form-label">Archivo CSV</label>
          <div class="input-group">
            <input id="fileCSV" type="file" class="form-control" accept=".csv,text/csv,text/plain">
            <button id="btnImportFile" class="btn btn-outline-primary">Subir CSV</button>
          </div>
          <div class="form-text mt-2">Formato: <code>username;password;role;enabled</code></div>
          <div id="msgImportFile" class="small mt-2 text-muted"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de usuarios -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle" id="tblUsers">
          <thead class="table-light">
          <tr>
            <th style="width:90px">ID</th>
            <th>Usuario</th>
            <th style="width:170px">Rol</th>
            <th style="width:140px">Habilitado</th>
            <th class="text-end" style="width:180px">Acciones</th>
          </tr>
          </thead>
          <tbody>
          <tr><td colspan="5" class="text-center py-4 text-muted">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
const UAPI = '/api/usuarios';

const qs = s => document.querySelector(s);
const ce = (t,cls='') => { const e=document.createElement(t); if(cls) e.className=cls; return e; };

function toast(el, msg, ok=true){
  el.textContent = msg;
  el.className = 'small ' + (ok? 'text-success':'text-danger');
  setTimeout(()=> el.textContent='', 4000);
}

// -------- Crear
qs('#fNewUser').onsubmit = async (e)=>{
  e.preventDefault();
  const f = e.target;
  const body = {
    username: f.username.value.trim(),
    password: f.password.value,
    role: f.role.value,
    enabled: (f.enabled.value === 'true')
  };
  const r = await fetch(UAPI, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(r.ok){ f.reset(); toast(qs('#msgNew'),'Usuario creado', true); loadUsers(); }
  else { toast(qs('#msgNew'), await r.text(), false); }
};


// -------- Importar archivo
qs('#btnImportFile').onclick = async ()=>{
  const f = qs('#fileCSV').files[0];
  if(!f){ toast(qs('#msgImportFile'),'Selecciona un archivo', false); return; }
  const fd = new FormData(); fd.append('file', f);
  const r = await fetch(`${UAPI}/import`, { method:'POST', body: fd });
  if(r.ok){ const j=await r.json(); toast(qs('#msgImportFile'),`OK: ${j.ok} | Fallas: ${j.fail}`, true); loadUsers(); }
  else { toast(qs('#msgImportFile'),'Error importando', false); }
};

// -------- Listado
async function loadUsers(){
  const tb = qs('#tblUsers tbody');
  tb.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">Cargando…</td></tr>`;
  const r = await fetch(UAPI);
  if(!r.ok){ tb.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger">No se pudo cargar</td></tr>`; return; }
  const L = await r.json();
  if(!L.length){ tb.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">Sin usuarios</td></tr>`; return; }

  tb.innerHTML='';
  L.forEach(u=>{
    const tr = ce('tr');
    tr.innerHTML = `
      <td>${u.id}</td>
      <td>${u.username}</td>
      <td>
        <select class="form-select form-select-sm">
          <option value="CLIENTE">CLIENTE</option>
          <option value="COMENSAL">COMENSAL</option>
          <option value="ADMIN">ADMIN</option>
        </select>
      </td>
      <td>
        <select class="form-select form-select-sm">
          <option value="true">Sí</option>
          <option value="false">No</option>
        </select>
      </td>
      <td class="text-end">
        <button class="btn btn-sm btn-secondary me-1">Guardar</button>
        <button class="btn btn-sm btn-danger">Eliminar</button>
      </td>
    `;
    // set values
    tr.children[2].querySelector('select').value = u.role;
    tr.children[3].querySelector('select').value = String(u.enabled);

    // guardar
    tr.children[4].querySelector('.btn-secondary').onclick = async ()=>{
      const role = tr.children[2].querySelector('select').value;
      const enabled = tr.children[3].querySelector('select').value === 'true';
      // Actualiza rol
      const r1 = await fetch(`${UAPI}/${u.id}/rol`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ role }) });
      // Actualiza enabled
      const r2 = await fetch(`${UAPI}/${u.id}/enabled`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ enabled }) });
      if(r1.ok && r2.ok){ loadUsers(); }
      else { alert('No se pudo guardar'); }
    };

    // eliminar
    tr.children[4].querySelector('.btn-danger').onclick = async ()=>{
      if(!confirm(`Eliminar usuario ${u.username}?`)) return;
      const rr = await fetch(`${UAPI}/${u.id}`, { method:'DELETE' });
      if(rr.ok){ loadUsers(); } else { alert('No se pudo eliminar'); }
    };

    tb.appendChild(tr);
  });
}

loadUsers();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
