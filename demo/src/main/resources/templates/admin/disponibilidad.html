<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Disponibilidad (Admin)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .slot{cursor:pointer; user-select:none}
    .slot.disponible{background:#e8f5e9}
    .slot.reservado{background:#ffebee}
    .slot:hover{outline:2px solid #0d6efd}
  </style>
</head>
<body class="p-3">
<div th:replace="fragments/navbar :: main"></div>

t>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Disponibilidad</h2>
   
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <label class="form-label">Mesa</label>
      <select id="mesa" class="form-select"></select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Fecha</label>
      <input id="fecha" type="date" class="form-control">
    </div>
    <div class="col-md-4">
      <label class="form-label">Duración (min)</label>
      <select id="mins" class="form-select">
        <option value="60">60</option>
        <option value="120">120</option>
        <option value="180" selected>180</option>
      </select>
    </div>
  </div>

  <div class="alert alert-info">Haz click en un cuadro **Disponible** para crear reserva/bloqueo; haz click en un cuadro **Reservado** para <b>cancelar</b>.</div>

  <div class="card"><div class="card-body">
    <div id="grid" class="row g-2"></div>
  </div></div>
</div>

<script>
const API_MESAS='/api/mesas', API_RES='/api/reservas';
const apertura='12:00', cierre='23:00'; // usa tus endpoints de AppConfig si quieres leerlos dinámicamente

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadMesas();
  const f=document.getElementById('fecha'); f.valueAsNumber = Date.now() - (new Date()).getTimezoneOffset()*60000;
  buildGrid(); loadDay();
  document.getElementById('mesa').onchange=loadDay;
  document.getElementById('fecha').onchange=loadDay;
  document.getElementById('mins').onchange=buildGrid;
});

async function loadMesas(){
  const r=await fetch(API_MESAS); const L=r.ok?await r.json():[];
  const sel=document.getElementById('mesa'); sel.innerHTML='';
  L.forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.text=`Mesa ${m.numero} (${m.capacidad})`; sel.appendChild(o); });
}

function parseHM(s){const [h,m]=s.split(':').map(Number); return h*60+m;}
function toTimeStr(min){const h=String(Math.floor(min/60)).padStart(2,'0'); const m=String(min%60).padStart(2,'0'); return `${h}:${m}`;}

function buildGrid(){
  const grid=document.getElementById('grid'); grid.innerHTML='';
  const step=60; const dur=+document.getElementById('mins').value;
  const start=parseHM(apertura), end=parseHM(cierre);
  for(let t=start; t+dur<=end; t+=step){
    const col=document.createElement('div'); col.className='col-12 col-md-4';
    const card=document.createElement('div'); card.className='p-3 border rounded slot disponible'; card.dataset.inicio=toTimeStr(t);
    card.innerHTML=`<strong>${toTimeStr(t)}</strong> – ${toTimeStr(t+dur)} <span class="badge text-bg-success ms-2">Disponible</span>`;
    card.onclick=clickSlot;
    col.appendChild(card); grid.appendChild(col);
  }
  loadDay(); // repinta estados reservados
}

async function loadDay(){
  const mesaId=document.getElementById('mesa').value;
  const fecha=document.getElementById('fecha').value;
  if(!mesaId || !fecha) return;
  const r=await fetch(`${API_RES}/dia?mesaId=${mesaId}&fecha=${fecha}`);
  const res= r.ok? await r.json(): [];
  // limpia estados
  document.querySelectorAll('.slot').forEach(el=>{
    el.classList.remove('reservado'); el.classList.add('disponible');
    el.querySelector('.badge').className='badge text-bg-success ms-2'; el.querySelector('.badge').textContent='Disponible';
    el.dataset.reservaId='';
  });
  // marca reservados
  res.forEach(x=>{
    const hm = x.inicio.substring(11,16); // "HH:mm"
    const slot = Array.from(document.querySelectorAll('.slot')).find(el => el.dataset.inicio===hm);
    if(slot){
      slot.classList.remove('disponible'); slot.classList.add('reservado'); slot.dataset.reservaId=x.id;
      slot.querySelector('.badge').className='badge text-bg-danger ms-2'; slot.querySelector('.badge').textContent='Reservado';
    }
  });
}

async function clickSlot(e){
  const el=e.currentTarget;
  const mesaId=document.getElementById('mesa').value;
  const fecha=document.getElementById('fecha').value;
  const dur=+document.getElementById('mins').value;

  // cancelar si está reservado
  if(el.classList.contains('reservado')){
    if(!confirm('Cancelar esta reserva?')) return;
    const id=el.dataset.reservaId;
    const r=await fetch(`${API_RES}/${id}`,{method:'DELETE'});
    if(r.ok) loadDay();
    return;
  }
  // crear/bloquear
  const inicio = new Date(`${fecha}T${el.dataset.inicio}:00`);
  const dto={mesaId:+mesaId, inicio: inicio.toISOString().replace('.000',''), minutos: dur};
  const r=await fetch(API_RES,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(dto)});
  if(r.ok) loadDay();
}
</script>
<script src="/js/disponibilidad.js"></script>
</body>
</html>
