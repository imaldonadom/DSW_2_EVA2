<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mesas (Admin)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table td input, .table td select { max-width: 160px; }
  </style>
</head>
<body class="p-3">

<!-- Navbar común (si la usas) -->
<div th:replace="fragments/navbar :: main"></div>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Mesas</h2>
    <div>
      <a class="btn btn-outline-secondary me-2" th:href="@{/admin}">Volver</a>
      <a class="btn btn-warning" th:href="@{/logout}">Salir</a>
    </div>
  </div>

  <!-- Crear -->
  <div class="card mb-3">
    <div class="card-header">Crear mesa</div>
    <div class="card-body">
      <form id="fNew" class="row g-2">
        <div class="col-md-2">
          <label class="form-label">Número</label>
          <input name="numero" type="number" min="1" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Capacidad</label>
          <input name="capacidad" type="number" min="1" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Ubicación</label>
          <input name="ubicacion" class="form-control" placeholder="Interior / Terraza / etc.">
        </div>
        <div class="col-md-2">
          <label class="form-label">Fumadores</label>
          <select name="fumadores" class="form-select">
            <option value="false">No</option>
            <option value="true">Sí</option>
          </select>
        </div>
        <div class="col-md-2 d-grid">
          <label class="form-label d-none d-md-block">&nbsp;</label>
          <button class="btn btn-primary">Agregar</button>
        </div>
      </form>
      <div id="msgNew" class="small mt-2"></div>
    </div>
  </div>

  <!-- Importar CSV -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Importar mesas (CSV)</span>
      <a class="btn btn-outline-secondary btn-sm" href="/api/admin/mesas/plantilla">Descargar plantilla CSV</a>
    </div>
    <div class="card-body">
      <div class="row g-2 align-items-center">
        <div class="col-md-6">
          <div class="input-group">
            <input id="csvMesas" type="file" class="form-control" accept=".csv,text/csv">
            <button id="btnUploadMesas" class="btn btn-outline-primary">Subir CSV</button>
          </div>
          <div class="form-text">
            Formato: <code>numero;capacidad;ubicacion;fumadores</code>
          </div>
        </div>
      </div>
      <div id="msgImport" class="small mt-2"></div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0" id="tbl">
          <thead class="table-light">
          <tr>
            <th style="width:80px;">ID</th>
            <th>Número</th>
            <th>Capacidad</th>
            <th>Ubicación</th>
            <th>Fumadores</th>
            <th class="text-end" style="width:180px;">Acciones</th>
          </tr>
          </thead>
          <tbody>
          <tr><td colspan="6" class="text-center py-4 text-muted">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // *** RUTAS DE ADMIN ***
  const API = '/api/admin/mesas';

  // Helpers de mensajes
  function setMsg(el, text, ok=true){
    el.textContent = text || '';
    el.className = 'small mt-2 ' + (ok ? 'text-success' : 'text-danger');
  }

  // Crear mesa
  document.getElementById('fNew').addEventListener('submit', async (e) => {
    e.preventDefault();
    const f = e.target;
    const msg = document.getElementById('msgNew');

    const dto = {
      numero: +f.numero.value,
      capacidad: +f.capacidad.value,
      ubicacion: f.ubicacion.value || '',
      fumadores: (f.fumadores.value === 'true')
    };

    try {
      const r = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dto)
      });
      if(!r.ok){
        const t = await r.text();
        setMsg(msg, 'Error al crear mesa: ' + t, false);
        return;
      }
      f.reset();
      setMsg(msg, 'Mesa creada correctamente.', true);
      await loadMesas();
    } catch (err){
      setMsg(msg, 'Error de red: ' + err, false);
    }
  });

  // Importar CSV (archivo)
  document.getElementById('btnUploadMesas').addEventListener('click', async () => {
    const fileInput = document.getElementById('csvMesas');
    const msg = document.getElementById('msgImport');
    const f = fileInput.files[0];
    if(!f){
      setMsg(msg, 'Selecciona un archivo CSV.', false);
      return;
    }
    const fd = new FormData();
    fd.append('file', f);
    try {
      const r = await fetch(`${API}/import`, { method: 'POST', body: fd });
      if(!r.ok){
        const t = await r.text();
        setMsg(msg, 'Error al importar: ' + t, false);
        return;
      }
      const j = await r.json().catch(() => ({}));
      const resumen = j && (j.ok !== undefined)
        ? `Importado: OK ${j.ok} | Fallas ${j.fail}`
        : 'Archivo importado.';
      setMsg(msg, resumen, true);
      await loadMesas();
      fileInput.value = '';
    } catch(err){
      setMsg(msg, 'Error de red: ' + err, false);
    }
  });

  // Carga y render de mesas
  async function loadMesas(){
    const tb = document.querySelector('#tbl tbody');
    tb.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Cargando...</td></tr>';
    try{
      const r = await fetch(API);
      const L = r.ok ? await r.json() : [];
      if(!Array.isArray(L) || L.length === 0){
        tb.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Sin mesas</td></tr>';
        return;
      }
      tb.innerHTML = '';
      L.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.id}</td>
          <td><input class="form-control form-control-sm" value="${m.numero ?? ''}" type="number" min="1"></td>
          <td><input class="form-control form-control-sm" value="${m.capacidad ?? ''}" type="number" min="1"></td>
          <td><input class="form-control form-control-sm" value="${m.ubicacion ?? ''}"></td>
          <td>
            <select class="form-select form-select-sm">
              <option value="false" ${!m.fumadores ? 'selected' : ''}>No</option>
              <option value="true" ${m.fumadores ? 'selected' : ''}>Sí</option>
            </select>
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-secondary me-1">Guardar</button>
            <button class="btn btn-sm btn-danger">Eliminar</button>
          </td>
        `;

        // Guardar (PUT)
        tr.querySelector('.btn-secondary').onclick = async () => {
          const dto = {
            id: m.id,
            numero: +tr.children[1].querySelector('input').value,
            capacidad: +tr.children[2].querySelector('input').value,
            ubicacion: tr.children[3].querySelector('input').value || '',
            fumadores: (tr.children[4].querySelector('select').value === 'true')
          };
          try {
            const r = await fetch(`${API}/${m.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(dto)
            });
            if(!r.ok){
              const t = await r.text();
              alert('Error al guardar: ' + t);
              return;
            }
            await loadMesas();
          } catch(err){
            alert('Error de red: ' + err);
          }
        };

        // Eliminar (DELETE)
        tr.querySelector('.btn-danger').onclick = async () => {
          if(!confirm(`Eliminar mesa ${m.numero}?`)) return;
          try {
            const r = await fetch(`${API}/${m.id}`, { method: 'DELETE' });
            if(!r.ok){
              const t = await r.text();
              alert('Error al eliminar: ' + t);
              return;
            }
            await loadMesas();
          } catch(err){
            alert('Error de red: ' + err);
          }
        };

        tb.appendChild(tr);
      });
    } catch(err){
      tb.innerHTML = `<tr><td colspan="6" class="text-danger">Error cargando mesas: ${err}</td></tr>`;
    }
  }

  // Init
  loadMesas();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
