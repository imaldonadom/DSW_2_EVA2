<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mesas (Admin)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-3">
<div th:replace="fragments/navbar :: main"></div>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Mesas</h2>
    <div>
      <a class="btn btn-outline-secondary me-2" th:href="@{/admin}">Volver</a>
      <a class="btn btn-warning" th:href="@{/logout}">Salir</a>
    </div>
  </div>

  <!-- Importar -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Importar mesas (CSV)</span>
      <a class="btn btn-outline-secondary btn-sm" th:href="@{/api/mesas/template}">Descargar plantilla CSV</a>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-start">
        <div class="col-lg-8">
          <label class="form-label">Pegar texto CSV</label>
          <textarea id="txtMesas" rows="6" class="form-control"
                    placeholder="numero;capacidad;ubicacion;fumadores&#10;1;4;Terraza;false"></textarea>
          <div class="mt-2 d-flex align-items-center gap-2">
            <button id="btnMText" class="btn btn-primary">Importar texto</button>
            <small id="msgMText" class="text-muted">No hay texto</small>
          </div>
        </div>
        <div class="col-lg-4">
          <label class="form-label">Archivo CSV</label>
          <div class="input-group">
            <input id="fileMesas" type="file" class="form-control" accept=".csv,text/csv,text/plain">
            <button id="btnMFile" class="btn btn-outline-primary">Subir CSV</button>
          </div>
          <div class="form-text">Formato: <code>numero;capacidad;ubicacion;fumadores</code></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="tblMesas">
          <thead class="table-light">
          <tr><th>ID</th><th>Número</th><th>Capacidad</th><th>Ubicación</th><th>Fumadores</th><th class="text-end">Acciones</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const MAPI = {
  list: '/api/mesas',                     // GET que ya usas para listar
  importText: '/api/mesas/import-text',
  importFile: '/api/mesas/import-file'
};

const msgM = (t, ok=true)=>{
  const el = document.getElementById('msgMText');
  el.textContent = t;
  el.className = 'text-' + (ok ? 'success' : 'danger');
};

document.getElementById('btnMText').onclick = async ()=>{
  const t = document.getElementById('txtMesas').value.trim();
  if(!t){ msgM('No hay texto', false); return; }
  msgM('Procesando...');
  const r = await fetch(MAPI.importText, { method:'POST', headers:{'Content-Type':'text/plain; charset=UTF-8'}, body:t });
  if(r.ok){
    const j = await r.json();
    msgM(`OK: ${j.ok} | Fallas: ${j.fail}`);
    loadMesas();
  }else{
    msgM('Error al importar', false);
  }
};

document.getElementById('btnMFile').onclick = async ()=>{
  const f = document.getElementById('fileMesas').files[0];
  if(!f){ msgM('Selecciona un archivo', false); return; }
  msgM('Subiendo...');
  const fd = new FormData(); fd.append('file', f);
  const r = await fetch(MAPI.importFile, { method:'POST', body:fd });
  if(r.ok){
    const j = await r.json();
    msgM(`OK: ${j.ok} | Fallas: ${j.fail}`);
    document.getElementById('fileMesas').value = '';
    loadMesas();
  }else{
    msgM('Error al importar archivo', false);
  }
};

async function loadMesas(){
  const tb = document.querySelector('#tblMesas tbody');
  tb.innerHTML = '';
  try{
    const r = await fetch(MAPI.list);
    if(!r.ok) return;
    const L = await r.json();
    L.forEach(m=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m.id ?? ''}</td>
        <td>${m.numero ?? ''}</td>
        <td>${m.capacidad ?? ''}</td>
        <td>${m.ubicacion ?? ''}</td>
        <td>${m.fumadores ? 'Sí' : 'No'}</td>
        <td class="text-end"><span class="text-muted small">–</span></td>`;
      tb.appendChild(tr);
    });
  }catch(e){}
}
loadMesas();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
